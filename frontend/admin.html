
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AgroGan - Admin</title>

<style>
:root{--brand:#21a35b;}
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#222;background:#fff;}
.nav{display:flex;gap:1rem;align-items:center;padding:1rem 2rem;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;}
.nav a{color:#111;text-decoration:none;font-weight:600;}
.container{max-width:1100px;margin:0 auto;padding:1rem;}
.hero{display:grid;grid-template-columns:1.2fr 1fr;gap:2rem;align-items:center;padding:3rem 0;}
.hero h1{font-size:clamp(2rem,4vw,3rem);margin:0;}
.card{border:1px solid #eee;border-radius:16px;padding:1rem;box-shadow:0 2px 10px rgba(0,0,0,.03);background:#fff;}
.btn{background:var(--brand);color:white;border:none;padding:.7rem 1.1rem;border-radius:12px;cursor:pointer;font-weight:600;}
input,select{padding:.6rem;border-radius:10px;border:1px solid #ccc;width:100%;}
table{width:100%;border-collapse:collapse;} th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left;}
.grid{display:grid;gap:1rem;}
.grid-2{grid-template-columns:repeat(2,1fr);} .grid-3{grid-template-columns:repeat(3,1fr);} .grid-4{grid-template-columns:repeat(4,1fr);}
.badge{display:inline-block;background:#eef7f1;color:#0b6a38;padding:.2rem .5rem;border-radius:999px;font-size:.8rem;}
small.muted{color:#666;}
</style>

</head><body>
<nav class="nav">
  <a href="index.html">AgroGan</a>
  <a href="catalogo.html">Catálogo</a>
  <a href="login.html">Login</a>
  <a href="register.html">Registro</a>
  <a href="admin.html">Admin</a>
  <span style="margin-left:auto"></span>
  <button class="btn" onclick="logout()">Salir</button>
</nav>
<div class="container">
  <div id="guard" class="card" style="display:none"><b>Verificando rol...</b></div>

  <div id="adminPanels" style="display:none" class="grid grid-2">
    <div class="card">
      <h3>Registrar animal</h3>
      <div class="grid grid-3">
        <label>Tag/Arete <input id="tag_code"></label>
        <label>Nombre <input id="name"></label>
        <label>Sexo
          <select id="sex">
            <option value="U">Desconocido</option><option value="M">Macho</option><option value="F">Hembra</option>
          </select>
        </label>
        <label>Nacimiento <input id="birth_date" type="date"></label>
        <label>Especie ID <input id="species_id" type="number" min="1"></label>
        <label>Raza ID <input id="breed_id" type="number" min="1"></label>
        <label>Finca ID <input id="farm_id" type="number" min="1"></label>
        <label>Color <input id="color"></label>
        <label>Estado <input id="status" value="activo"></label>
      </div>
      <div style="margin-top:1rem;"><button class="btn" onclick="crearAnimal()">Crear</button></div>
      <div id="msg" style="margin-top:.5rem;"></div>
    </div>

    <div class="card">
      <h3>Seleccionar animales para catálogo</h3>
      <div class="grid">
        <label>Búsqueda <input id="q" placeholder="tag o nombre" oninput="listarAnimales()"></label>
        <table>
          <thead><tr><th>ID</th><th>Tag</th><th>Nombre</th><th>Especie</th><th>Acciones</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>Usuarios</h3>
      <table>
        <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Acción</th></tr></thead>
        <tbody id="users"></tbody>
      </table>
    </div>
  </div>

  <div id="noAdmin" class="card" style="display:none">
    <b>Acceso permitido solo a administradores.</b><br>
    Inicia sesión con una cuenta admin o solicita promoción.
  </div>
</div>

<script>
const API = localStorage.getItem('API_URL') || 'http://localhost:3000';
function setApiUrl(url){ localStorage.setItem('API_URL', url); document.querySelectorAll('.currentApi').forEach(e=>e.textContent=url); }
function getToken(){ return localStorage.getItem('token') || ''; }
function setToken(t){ localStorage.setItem('token', t); }
function clearToken(){ localStorage.removeItem('token'); }
function authHeaders(extra={}){ return Object.assign({'Authorization':'Bearer '+getToken()}, extra); }
async function me(){ if(!getToken()) return null; try{ const r=await fetch(API+'/api/auth/me',{headers:authHeaders()}); if(!r.ok) return null; return (await r.json()).user; }catch(e){ return null; } }
</script>

<script>
function logout(){ clearToken(); location.href='login.html'; }

async function ensureAdmin(){
  document.getElementById('guard').style.display='block';
  const u = await me();
  document.getElementById('guard').style.display='none';
  if(!u){ location.href='login.html'; return; }
  if(u.role !== 'admin'){
    document.getElementById('noAdmin').style.display='block';
    return;
  }
  document.getElementById('adminPanels').style.display='block';
  await listarAnimales();
  await listarUsuarios();
}

async function crearAnimal(){
  const data = {
    tag_code: document.getElementById('tag_code').value.trim(),
    name: document.getElementById('name').value.trim()||undefined,
    sex: document.getElementById('sex').value,
    birth_date: document.getElementById('birth_date').value || undefined,
    species_id: document.getElementById('species_id').value||undefined,
    breed_id: document.getElementById('breed_id').value||undefined,
    farm_id: document.getElementById('farm_id').value||undefined,
    color: document.getElementById('color').value||undefined,
    status: document.getElementById('status').value||'activo'
  };
  const r = await fetch(API+'/api/animals',{method:'POST',headers:Object.assign({'Content-Type':'application/json'},authHeaders()),body:JSON.stringify(data)});
  const j = await r.json();
  const el = document.getElementById('msg');
  if(!r.ok){ el.style.color='crimson'; el.textContent = j.error || (j.errors && j.errors[0]?.msg) || 'Error'; return; }
  el.style.color='green'; el.textContent='Animal creado (ID '+j.id+')';
  await listarAnimales();
}

async function listarAnimales(){
  const q = document.getElementById('q').value||'';
  const url = API + '/api/animals?q=' + encodeURIComponent(q) + '&page=1&pageSize=20';
  const r = await fetch(url,{headers:authHeaders()});
  const j = await r.json();
  const tb = document.getElementById('rows');
  if(!r.ok){ tb.innerHTML = '<tr><td colspan=5 style=color:crimson>'+ (j.error||'Error') +'</td></tr>'; return; }
  tb.innerHTML = (j.data||[]).map(a => `
    <tr>
      <td>${a.id}</td><td>${a.tag_code}</td><td>${a.name||''}</td><td>${a.species||''}</td>
      <td style="display:flex;gap:.3rem;flex-wrap:wrap">
        <button class="btn" onclick="editarAnimal(${a.id})" style="font-size:.8rem;padding:.4rem .6rem">Editar</button>
        <button class="btn" onclick="agregarCatalogo(${a.id})" style="font-size:.8rem;padding:.4rem .6rem">Agregar</button>
        <button onclick="quitarCatalogo(${a.id})" style="font-size:.8rem;padding:.4rem .6rem">Quitar</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan=5>Sin resultados</td></tr>';
}

async function agregarCatalogo(id){
  const r = await fetch(API+'/api/admin/catalog/'+id,{method:'POST',headers:authHeaders({'Content-Type':'application/json'})});
  if(!r.ok){ const j=await r.json(); alert(j.error||'Error'); }
  await listarAnimales();
}

async function quitarCatalogo(id){
  const r = await fetch(API+'/api/admin/catalog/'+id,{method:'DELETE',headers:authHeaders()});
  if(!r.ok){ const j=await r.json(); alert(j.error||'Error'); }
  await listarAnimales();
}

async function listarUsuarios(){
  const r = await fetch(API+'/api/admin/users',{headers:authHeaders()});
  const j = await r.json();
  const tb = document.getElementById('users');
  if(!r.ok){ tb.innerHTML = '<tr><td colspan=5 style=color:crimson>'+ (j.error||'Error') +'</td></tr>'; return; }
  tb.innerHTML = (j.users||[]).map(u => `
    <tr>
      <td>${u.id}</td><td>${u.name}</td><td>${u.email}</td><td><span class="badge">${u.role}</span></td>
      <td>
        <button onclick="setRole(${u.id}, 'user')">User</button>
        <button class="btn" onclick="setRole(${u.id}, 'admin')">Admin</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan=5>Sin usuarios</td></tr>';
}

async function setRole(id, role){
  const r = await fetch(API+'/api/admin/users/'+id+'/role',{method:'PATCH',headers:authHeaders({'Content-Type':'application/json'}),body:JSON.stringify({role})});
  if(!r.ok){ const j=await r.json(); alert(j.error||'Error'); return; }
  await listarUsuarios();
}

let editingAnimalId = null;

async function editarAnimal(id){
  editingAnimalId = id;
  const r = await fetch(API+'/api/animals/'+id,{headers:authHeaders()});
  const j = await r.json();
  if(!r.ok){ alert(j.error||'Error'); return; }
  
  // Llenar el formulario con los datos del animal
  document.getElementById('tag_code').value = j.tag_code||'';
  document.getElementById('name').value = j.name||'';
  document.getElementById('sex').value = j.sex||'U';
  document.getElementById('birth_date').value = j.birth_date||'';
  document.getElementById('species_id').value = j.species_id||'';
  document.getElementById('breed_id').value = j.breed_id||'';
  document.getElementById('farm_id').value = j.farm_id||'';
  document.getElementById('color').value = j.color||'';
  document.getElementById('status').value = j.status||'activo';
  
  // Cambiar el texto del botón
  const btn = document.querySelector('.btn[onclick="crearAnimal()"]');
  btn.textContent = 'Actualizar Animal';
  btn.setAttribute('onclick', 'actualizarAnimal()');
  
  // Mostrar botón de cancelar
  const form = document.querySelector('.card h3');
  form.innerHTML = 'Editar animal <button type="button" onclick="cancelarEdicion()" style="margin-left:1rem;font-size:.8rem;padding:.3rem .6rem;background:#ccc;color:#333">Cancelar</button>';
}

async function actualizarAnimal(){
  if(!editingAnimalId) return;
  
  const data = {
    tag_code: document.getElementById('tag_code').value.trim(),
    name: document.getElementById('name').value.trim()||undefined,
    sex: document.getElementById('sex').value,
    birth_date: document.getElementById('birth_date').value || undefined,
    species_id: document.getElementById('species_id').value||undefined,
    breed_id: document.getElementById('breed_id').value||undefined,
    farm_id: document.getElementById('farm_id').value||undefined,
    color: document.getElementById('color').value||undefined,
    status: document.getElementById('status').value||'activo'
  };
  
  const r = await fetch(API+'/api/animals/'+editingAnimalId,{method:'PUT',headers:Object.assign({'Content-Type':'application/json'},authHeaders()),body:JSON.stringify(data)});
  const j = await r.json();
  const el = document.getElementById('msg');
  if(!r.ok){ el.style.color='crimson'; el.textContent = j.error || (j.errors && j.errors[0]?.msg) || 'Error'; return; }
  el.style.color='green'; el.textContent='Animal actualizado';
  
  cancelarEdicion();
  await listarAnimales();
}

function cancelarEdicion(){
  editingAnimalId = null;
  
  // Limpiar formulario
  document.getElementById('tag_code').value = '';
  document.getElementById('name').value = '';
  document.getElementById('sex').value = 'U';
  document.getElementById('birth_date').value = '';
  document.getElementById('species_id').value = '';
  document.getElementById('breed_id').value = '';
  document.getElementById('farm_id').value = '';
  document.getElementById('color').value = '';
  document.getElementById('status').value = 'activo';
  
  // Restaurar botón y título
  const btn = document.querySelector('.btn[onclick="actualizarAnimal()"]');
  if(btn){
    btn.textContent = 'Crear';
    btn.setAttribute('onclick', 'crearAnimal()');
  }
  document.querySelector('.card h3').textContent = 'Registrar animal';
  
  // Limpiar mensajes
  document.getElementById('msg').textContent = '';
}

ensureAdmin();
</script>
</body></html>
